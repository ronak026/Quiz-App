{% extends "base.html" %}

{% block title %}Create Quiz{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto p-6 content-center">

    <h1 class="text-3xl font-bold mb-6 text-center font-serif">Create a New Quiz</h1>

    <!-- Quiz Title & Description -->
    <div class="bg-white rounded-xl shadow-md border border-gray-100 mb-6 w-full max-w-2xl mx-auto p-8">
        <label class="block font-semibold text-gray-700 mb-1">Quiz Title</label>
        <input id="quiz-title"
               class="border px-4 py-2 rounded-lg w-full mb-4 focus:ring-2 focus:ring-primary focus:outline-none"
               placeholder="Enter quiz title">

        <label class="block font-semibold text-gray-700 mb-1">Description</label>
        <textarea id="quiz-description"
                  class="border px-4 py-2 rounded-lg w-full mb-4 focus:ring-2 focus:ring-primary focus:outline-none"
                  rows="3"
                  placeholder="Description (optional)"></textarea>
    </div>

    <!-- Questions Section -->
    <h2 class="text-2xl font-bold mb-4 text-center font-serif">Questions</h2>
    <div id="questions-container" class="space-y-6"></div>

    <div class="flex gap-6 mt-6">
        <button id="add-question"
                class="bg-blue-600 text-white px-5 py-2 rounded-xl font-semibold hover:bg-blue-700 transition duration-300 shadow p-6">
            Add Question
        </button>

        <button id="submit-quiz"
                class="bg-green-600 text-white px-5 py-2 rounded-xl font-semibold hover:bg-green-700 transition duration-300 shadow p-4">
            Save Quiz
        </button>
    </div>

    <div id="feedback" class="text-red-600 font-medium"></div>
</div>

<script>
    let questionsBox = document.getElementById("questions-container");
    let addQuestionBtn = document.getElementById("add-question");
    let submitBtn = document.getElementById("submit-quiz");
    let feedback = document.getElementById("feedback");

    function createAnswerRow(qIndex, aIndex) {
        return `
            <div class="flex gap-3 mb-2 answer-row items-center">
                <input type="radio" name="correct_${qIndex}" value="${aIndex}" class="w-4 h-4">
                <input type="text"
                       class="border px-3 py-2 rounded-lg w-full focus:ring-2 focus:ring-primary focus:outline-none"
                       placeholder="Answer text">
            </div>
        `;
    }

    function createQuestionBlock(index) {
        return `
            <div class="bg-white w-full max-w-2xl mx-auto p-8 rounded-xl shadow-md border border-gray-100 question-block" data-index="${index}">
                <label class="font-semibold text-gray-700 mb-4 block">Question ${index + 1}</label>
                <input type="text"
                       class="border px-3 py-2 rounded-lg w-full mb-3 focus:ring-2 focus:ring-primary focus:outline-none question-text"
                       placeholder="Enter question text">

                <div class="answers space-y-2 mt-3 ml-3">
                    ${createAnswerRow(index, 0)}
                    ${createAnswerRow(index, 1)}
                </div>

                <button type="button"
                        class="bg-blue-600 from-blue-600 to-purple-500 text-white px-4 py-2 rounded-xl mt-4 add-answer 
                            hover:from-blue-600 hover:to-purple-600 transition duration-200 font-medium text-lg">
                    + Add Answer
                </button>


            </div>
        `;
    }

    addQuestionBtn.onclick = () => {
        let index = document.querySelectorAll(".question-block").length;
        questionsBox.insertAdjacentHTML("beforeend", createQuestionBlock(index));

        let block = questionsBox.lastElementChild;

        block.querySelector(".add-answer").onclick = () => {
            let answersDiv = block.querySelector(".answers");
            let aIndex = answersDiv.querySelectorAll(".answer-row").length;
            answersDiv.insertAdjacentHTML("beforeend", createAnswerRow(index, aIndex));
        };
    };

    // Add 1 default question
    addQuestionBtn.click();

    submitBtn.onclick = async () => {
        const title = document.getElementById("quiz-title").value.trim();
        const desc = document.getElementById("quiz-description").value.trim();

        let payload = {
            title: title,
            description: desc,
            questions: []
        };

        document.querySelectorAll(".question-block").forEach((block) => {
            const qText = block.querySelector(".question-text").value.trim();
            let answers = [];

            block.querySelectorAll(".answer-row").forEach((row) => {
                const text = row.querySelector("input[type='text']").value.trim();
                const isCorrect = row.querySelector("input[type='radio']").checked;
                if (text) answers.push({ text: text, is_correct: isCorrect });
            });

            payload.questions.push({
                text: qText,
                answers: answers
            });
        });

        const res = await fetch("{% url 'create_quiz' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}",
            },
            body: JSON.stringify(payload)
        });

        const data = await res.json();

        if (!data.ok) {
            feedback.innerHTML = data.errors.map(e => `<div>${e}</div>`).join("");
        } else {
            window.location.href = data.redirect;
        }
    };
</script>
{% endblock %}
